(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();class y{worker=null;messagesContainer=null;typingIndicator=null;statusElement=null;isGenerating=!1;onProgress;startTime=0;timerInterval=null;shouldStop=!1;messageQueue=[];constructor(){this.messagesContainer=document.getElementById("chatMessages"),this.typingIndicator=null,this.statusElement=document.getElementById("status")}async initialize(){return new Promise((e,t)=>{this.worker=new Worker(new URL("/gemma-chat-app/assets/modelWorker-BUCKR6Kh.js",import.meta.url),{type:"module"}),this.worker.onmessage=o=>{const{type:r,data:n,error:s}=o.data;switch(r){case"ready":console.log("‚úÖ Model worker ready"),e();break;case"progress":this.onProgress&&this.onProgress(n.progress,n.message);break;case"token":this.appendToCurrentMessage(n.token);break;case"complete":this.completeGeneration();break;case"error":console.error("Worker error:",s),this.handleError(s),t(new Error(s));break}},this.worker.postMessage({type:"init"})})}addUserMessage(e){const t=document.createElement("div");t.className="message user-message",t.textContent=e,this.messagesContainer?.appendChild(t),this.scrollToBottom()}async generateResponse(e){if(!this.worker)return;if(this.isGenerating){this.messageQueue.push(e),console.log(`üì• Message queued (${this.messageQueue.length} in queue)`);return}this.isGenerating=!0,this.startTimer();const t=document.createElement("div");t.className="message ai-message",t.id="current-ai-message",t.textContent="",this.messagesContainer?.appendChild(t),this.statusElement&&(this.statusElement.textContent="ü§î Thinking..."),this.worker.postMessage({type:"generate",data:{message:e}})}appendToCurrentMessage(e){const t=document.getElementById("current-ai-message");t&&(t.textContent+=e,this.scrollToBottom()),this.statusElement&&(this.statusElement.textContent="üí≠ Generating response...")}completeGeneration(){if(this.shouldStop)return;this.isGenerating=!1,this.stopTimer();const e=document.getElementById("current-ai-message");if(e&&e.removeAttribute("id"),this.resetUI(),this.messageQueue.length>0){const t=this.messageQueue.shift();console.log(`üì§ Processing queued message (${this.messageQueue.length} remaining)`),this.addUserMessage(t),setTimeout(()=>this.generateResponse(t),100)}}handleError(e){this.isGenerating=!1,this.timerInterval!==null&&(clearInterval(this.timerInterval),this.timerInterval=null),this.stopTimer();const t=document.createElement("div");t.className="message ai-message",t.style.background="#ffebee",t.style.color="#c62828",t.textContent=`‚ùå Error: ${e}`,this.messagesContainer?.appendChild(t),this.resetUI(),this.scrollToBottom()}startTimer(){this.shouldStop=!1;const e=document.getElementById("chatInput"),t=document.getElementById("sendButton"),o=document.getElementById("stopButton");e&&(e.disabled=!0),t&&o&&(t.style.display="none",o.style.display="inline-block",o.onclick=()=>this.stopGeneration()),this.startTime=Date.now(),o&&this.updateButtonTimer(o)}updateButtonTimer(e){this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{if(!this.isGenerating||this.shouldStop){clearInterval(this.timerInterval);return}const t=Math.floor((Date.now()-this.startTime)/1e3);e.textContent=`Stop (${t}s)`},100)}stopGeneration(){this.shouldStop=!0,this.isGenerating=!1,this.timerInterval!==null&&(clearInterval(this.timerInterval),this.timerInterval=null),this.stopTimer(),this.worker&&this.worker.postMessage({type:"stop"});const e=document.createElement("div");e.className="message ai-message",e.style.background="#fef3c7",e.style.color="#92400e",e.textContent="‚èπÔ∏è Generation stopped by user",this.messagesContainer?.appendChild(e),this.resetUI(),this.scrollToBottom()}stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}resetUI(){const e=document.getElementById("chatInput"),t=document.getElementById("sendButton"),o=document.getElementById("stopButton");e&&(e.disabled=!1),t&&o&&(t.style.display="inline-block",t.disabled=!1,t.textContent="Send",o.style.display="none",o.textContent="Stop"),this.statusElement&&(this.statusElement.textContent="Universal Browser Support + Transformers.js + Web Workers"),e?.focus()}setupSaveButton(){const e=document.getElementById("saveButton");e&&e.addEventListener("click",()=>this.saveChatToFile())}resetConversation(){this.worker&&this.worker.postMessage({type:"reset"})}saveChatToFile(){if(!this.messagesContainer)return;const e=this.messagesContainer.querySelectorAll(".message");if(e.length===0){alert("No messages to save!");return}const t=new Date,o=t.toLocaleString(),r=t.toISOString().split("T")[0],n=t.toTimeString().split(" ")[0].replace(/:/g,"-");let s=`ü™© Gemma 3 270M Chat Export ü™©
`;s+=`Date: ${o}
`,s+=`Model: Google Gemma 3 270M ONNX
`,s+=`Generated with: Gemma 3 270M - Universal Browser AI

`,s+=`${"=".repeat(60)}

`,e.forEach((c,h)=>{const g=c.classList.contains("user-message"),p=c.classList.contains("ai-message"),m=c.textContent||"";g?s+=`USER: ${m}

`:p&&!m.includes("‚èπÔ∏è Generation stopped")&&!m.includes("‚ùå Error:")?s+=`GEMMA 3 270M: ${m}

`:m.includes("‚èπÔ∏è Generation stopped")?s+=`[Generation stopped by user]

`:m.includes("‚ùå Error:")&&(s+=`[Error occurred: ${m.replace("‚ùå Error: ","")}]

`)}),s+=`${"=".repeat(60)}
`,s+=`End of chat export - ${o}
`,s+=`Total messages: ${e.length}
`;const u=new Blob([s],{type:"text/plain"}),d=URL.createObjectURL(u),i=document.createElement("a");i.href=d,i.download=`gemma3-270m-chat-${r}-${n}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(d);const l=document.getElementById("saveButton");if(l){const c=l.textContent;l.textContent="‚úÖ Saved!",setTimeout(()=>{l.textContent=c},2e3)}}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}}async function v(){if(!navigator.gpu)return console.warn("WebGPU is not supported in this browser, will use WASM"),!1;let a=null;try{const e=await navigator.gpu.requestAdapter();return e?(a=await e.requestDevice(),console.log("‚úÖ WebGPU is available:",a),!0):(console.warn("No WebGPU adapter found, will use WASM"),!1)}catch(e){return console.warn("WebGPU initialization failed, will use WASM:",e),!1}finally{a&&(a.destroy(),console.log("üßπ WebGPU detection device released"))}}async function f(){const a=document.getElementById("loadingOverlay"),e=document.getElementById("loadingStatus"),t=document.getElementById("status"),o=document.getElementById("chatInput"),r=document.getElementById("sendButton");try{e&&(e.textContent="Checking device capabilities...");const n=await v();console.log(n?"üöÄ Using WebGPU acceleration":"üîß Using WASM runtime for compatibility"),e&&(e.textContent="Initializing chat system...");const s=new y;s.onProgress=(i,l)=>{const c=document.getElementById("progressRingFill"),h=document.getElementById("progressPercentage"),g=Math.max(0,Math.min(100,i));if(c){const p=314-g/100*314;c.style.strokeDashoffset=p.toString()}h&&(h.textContent=`${Math.round(g)}%`),e&&(e.textContent=l)},e&&(e.textContent="Loading Gemma 270M model..."),await s.initialize(),s.resetConversation(),a?.classList.add("hidden"),o.disabled=!1,r.disabled=!1,t&&(t.textContent="Universal Browser Support + Transformers.js + Web Workers");const u=async()=>{const i=o.value.trim();!i||s.isGenerating||(s.addUserMessage(i),o.value="",await s.generateResponse(i))};r.addEventListener("click",u),o.addEventListener("keypress",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),u())}),s.setupSaveButton(),o.focus();const d=document.getElementById("resourceMonitor");if(d){d.style.display="block";const i=document.getElementById("runtimeType");i&&(i.textContent=n?"WebGPU":"WASM");const l=document.getElementById("modelStatus");l&&(l.textContent="Loaded"),C()}}catch(n){console.error("Failed to initialize app:",n),a?.classList.add("hidden");const s=document.createElement("div");s.className="error-message",s.textContent=`Error: ${n instanceof Error?n.message:"Failed to initialize"}`,document.querySelector(".container")?.prepend(s),t&&(t.textContent="‚ùå Failed to load model")}}function I(a){const e=a/1024/1024;return e<1024?`${Math.round(e)}MB`:`${(e/1024).toFixed(1)}GB`}function C(){const a=document.getElementById("memoryUsage"),e=document.getElementById("cpuUsage"),t=document.getElementById("messageCount");performance.now();const o=()=>{performance.now(),requestAnimationFrame(o)};requestAnimationFrame(o);const r=()=>{if(a)if("memory"in performance){const s=performance.memory.usedJSHeapSize;a.textContent=I(s)}else a.textContent="N/A";if(e&&(e.textContent="N/A",e.title="CPU usage monitoring not available in browser"),t){const n=document.querySelectorAll(".message");t.textContent=Math.max(0,n.length-1).toString()}};r(),setInterval(r,2e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
