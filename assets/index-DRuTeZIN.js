(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();class y{worker=null;messagesContainer=null;typingIndicator=null;statusElement=null;isGenerating=!1;onProgress;startTime=0;timerInterval=null;shouldStop=!1;constructor(){this.messagesContainer=document.getElementById("chatMessages"),this.typingIndicator=null,this.statusElement=document.getElementById("status")}async initialize(){return new Promise((e,t)=>{this.worker=new Worker(new URL("/gemma-chat-app/assets/modelWorker-DfJjCRtH.js",import.meta.url),{type:"module"}),this.worker.onmessage=n=>{const{type:r,data:o,error:s}=n.data;switch(r){case"ready":console.log("‚úÖ Model worker ready"),e();break;case"progress":this.onProgress&&this.onProgress(o.progress,o.message);break;case"token":this.appendToCurrentMessage(o.token);break;case"complete":this.completeGeneration();break;case"error":console.error("Worker error:",s),this.handleError(s),t(new Error(s));break}},this.worker.postMessage({type:"init"})})}addUserMessage(e){const t=document.createElement("div");t.className="message user-message",t.textContent=e,this.messagesContainer?.appendChild(t),this.scrollToBottom()}async generateResponse(e){if(!this.worker||this.isGenerating)return;this.isGenerating=!0,this.startTimer();const t=document.createElement("div");t.className="message ai-message",t.id="current-ai-message",t.textContent="",this.messagesContainer?.appendChild(t),this.statusElement&&(this.statusElement.textContent="ü§î Thinking..."),this.worker.postMessage({type:"generate",data:{message:e}})}appendToCurrentMessage(e){const t=document.getElementById("current-ai-message");t&&(t.textContent+=e,this.scrollToBottom()),this.statusElement&&(this.statusElement.textContent="üí≠ Generating response...")}completeGeneration(){if(this.shouldStop)return;this.isGenerating=!1,this.stopTimer();const e=document.getElementById("current-ai-message");e&&e.removeAttribute("id"),this.resetUI()}handleError(e){this.isGenerating=!1,this.stopTimer();const t=document.createElement("div");t.className="message ai-message",t.style.background="#ffebee",t.style.color="#c62828",t.textContent=`‚ùå Error: ${e}`,this.messagesContainer?.appendChild(t),this.resetUI(),this.scrollToBottom()}startTimer(){this.shouldStop=!1;const e=document.getElementById("chatInput"),t=document.getElementById("sendButton"),n=document.getElementById("stopButton");e&&(e.disabled=!0),t&&n&&(t.style.display="none",n.style.display="inline-block",n.onclick=()=>this.stopGeneration()),this.startTime=Date.now(),n&&this.updateButtonTimer(n)}updateButtonTimer(e){this.timerInterval&&clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{if(!this.isGenerating||this.shouldStop){clearInterval(this.timerInterval);return}const t=Math.floor((Date.now()-this.startTime)/1e3);e.textContent=`Stop (${t}s)`},100)}stopGeneration(){this.shouldStop=!0,this.isGenerating=!1,this.stopTimer(),this.worker&&this.worker.postMessage({type:"stop"});const e=document.createElement("div");e.className="message ai-message",e.style.background="#fef3c7",e.style.color="#92400e",e.textContent="‚èπÔ∏è Generation stopped by user",this.messagesContainer?.appendChild(e),this.resetUI(),this.scrollToBottom()}stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}resetUI(){const e=document.getElementById("chatInput"),t=document.getElementById("sendButton"),n=document.getElementById("stopButton");e&&(e.disabled=!1),t&&n&&(t.style.display="inline-block",t.disabled=!1,t.textContent="Send",n.style.display="none",n.textContent="Stop"),this.statusElement&&(this.statusElement.textContent="Universal Browser Support + Transformers.js + Web Workers"),e?.focus()}setupSaveButton(){const e=document.getElementById("saveButton");e&&e.addEventListener("click",()=>this.saveChatToFile())}resetConversation(){this.worker&&this.worker.postMessage({type:"reset"})}saveChatToFile(){if(!this.messagesContainer)return;const e=this.messagesContainer.querySelectorAll(".message");if(e.length===0){alert("No messages to save!");return}const t=new Date,n=t.toLocaleString(),r=t.toISOString().split("T")[0],o=t.toTimeString().split(" ")[0].replace(/:/g,"-");let s=`ü™© Gemma 3 270M Chat Export ü™©
`;s+=`Date: ${n}
`,s+=`Model: Google Gemma 3 270M ONNX
`,s+=`Generated with: Gemma 3 270M - Universal Browser AI

`,s+=`${"=".repeat(60)}

`,e.forEach((d,p)=>{const g=d.classList.contains("user-message"),h=d.classList.contains("ai-message"),u=d.textContent||"";g?s+=`USER: ${u}

`:h&&!u.includes("‚èπÔ∏è Generation stopped")&&!u.includes("‚ùå Error:")?s+=`GEMMA 3 270M: ${u}

`:u.includes("‚èπÔ∏è Generation stopped")?s+=`[Generation stopped by user]

`:u.includes("‚ùå Error:")&&(s+=`[Error occurred: ${u.replace("‚ùå Error: ","")}]

`)}),s+=`${"=".repeat(60)}
`,s+=`End of chat export - ${n}
`,s+=`Total messages: ${e.length}
`;const l=new Blob([s],{type:"text/plain"}),c=URL.createObjectURL(l),a=document.createElement("a");a.href=c,a.download=`gemma3-270m-chat-${r}-${o}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(c);const m=document.getElementById("saveButton");if(m){const d=m.textContent;m.textContent="‚úÖ Saved!",setTimeout(()=>{m.textContent=d},2e3)}}scrollToBottom(){this.messagesContainer&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}}async function C(){if(!navigator.gpu)return console.warn("WebGPU is not supported in this browser, will use WASM"),!1;try{const i=await navigator.gpu.requestAdapter();if(!i)return console.warn("No WebGPU adapter found, will use WASM"),!1;const e=await i.requestDevice();return console.log("‚úÖ WebGPU is available:",e),!0}catch(i){return console.warn("WebGPU initialization failed, will use WASM:",i),!1}}async function f(){const i=document.getElementById("loadingOverlay"),e=document.getElementById("loadingStatus"),t=document.getElementById("status"),n=document.getElementById("chatInput"),r=document.getElementById("sendButton");try{e&&(e.textContent="Checking device capabilities...");const o=await C();console.log(o?"üöÄ Using WebGPU acceleration":"üîß Using WASM runtime for compatibility"),e&&(e.textContent="Initializing chat system...");const s=new y;s.onProgress=(a,m)=>{const d=document.getElementById("progressRingFill"),p=document.getElementById("progressPercentage"),g=Math.max(0,Math.min(100,a));if(d){const h=314-g/100*314;d.style.strokeDashoffset=h.toString()}p&&(p.textContent=`${Math.round(g)}%`),e&&(e.textContent=m)},e&&(e.textContent="Loading Gemma 270M model..."),await s.initialize(),s.resetConversation(),i?.classList.add("hidden"),n.disabled=!1,r.disabled=!1,t&&(t.textContent="Universal Browser Support + Transformers.js + Web Workers");const l=async()=>{const a=n.value.trim();!a||s.isGenerating||(s.addUserMessage(a),n.value="",await s.generateResponse(a))};r.addEventListener("click",l),n.addEventListener("keypress",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),l())}),s.setupSaveButton(),n.focus();const c=document.getElementById("resourceMonitor");if(c){c.style.display="block";const a=document.getElementById("runtimeType");a&&(a.textContent=o?"WebGPU":"WASM");const m=document.getElementById("modelStatus");m&&(m.textContent="Loaded"),v()}}catch(o){console.error("Failed to initialize app:",o),i?.classList.add("hidden");const s=document.createElement("div");s.className="error-message",s.textContent=`Error: ${o instanceof Error?o.message:"Failed to initialize"}`,document.querySelector(".container")?.prepend(s),t&&(t.textContent="‚ùå Failed to load model")}}function E(i){const e=i/1024/1024;return e<1024?`${Math.round(e)}MB`:`${(e/1024).toFixed(1)}GB`}function v(){const i=document.getElementById("memoryUsage"),e=document.getElementById("cpuUsage"),t=document.getElementById("messageCount");let n=[],r=performance.now();const o=()=>{const l=performance.now(),c=l-r;r=l,n.push(c),n.length>10&&n.shift(),requestAnimationFrame(o)};requestAnimationFrame(o);const s=()=>{if(i)if("memory"in performance){const c=performance.memory.usedJSHeapSize;i.textContent=E(c)}else i.textContent="N/A";if(e&&n.length>0){const l=n.reduce((g,h)=>g+h,0)/n.length,c=16.67,a=Math.min(100,Math.max(0,(l-c)/c*100+10)),m=performance.now(),d=performance.now()-m,p=Math.min(100,Math.max(5,a*.7+d*10));e.textContent=`${Math.round(p)}%`}if(t){const l=document.querySelectorAll(".message");t.textContent=Math.max(0,l.length-1).toString()}};s(),setInterval(s,2e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
